name: Deploy to Development

on:
  push:
    branches:
    - develop
  workflow_dispatch:
    # Allow manual trigger

env:
  DBT_TARGET: dev
  DBT_PROFILES_DIR: ./dbt
  ENVIRONMENT: development

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Validate DBT project structure
      run: |
        echo "üîç Validating DBT project structure..."
        if [ ! -f "dbt/dbt_project.yml" ]; then
          echo "‚ùå dbt_project.yml not found"
          exit 1
        fi

        if [ ! -f "dbt/profiles.yml" ]; then
          echo "‚ùå profiles.yml not found"
          exit 1
        fi

        if [ ! -d "dbt/models" ]; then
          echo "‚ùå models directory not found"
          exit 1
        fi

        echo "‚úÖ DBT project structure is valid"

    - name: Check for breaking changes
      run: |
        echo "üîç Checking for breaking changes..."

        # Check if any models were deleted
        if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
          DELETED_MODELS=$(git diff --name-status HEAD~1 HEAD | grep "^D.*\.sql$" | wc -l)
          if [ $DELETED_MODELS -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: $DELETED_MODELS model(s) deleted. Ensure downstream dependencies are updated."
            git diff --name-status HEAD~1 HEAD | grep "^D.*\.sql$" || true
          fi
        else
          echo "‚ÑπÔ∏è  Only one commit found (no HEAD~1). Skipping deleted models check."
        fi

        echo "‚úÖ Pre-deployment checks passed"

  deploy-development:
    name: Deploy to Development Environment
    runs-on: ubuntu-latest
    needs: pre-deployment-checks

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install DBT and dependencies
      run: |
        echo "üì¶ Installing DBT..."
        pip install dbt-sqlserver==1.8.2

    - name: Install DBT packages
      run: |
        echo "üì¶ Installing DBT packages (dbt_utils, dbt_expectations)..."
        cd dbt
        dbt deps --profiles-dir .

    - name: Verify DBT package integrity
      run: |
        echo "üîí Verifying DBT package integrity..."
        cd dbt
        if [ ! -f "../dbt_packages.hash" ]; then
          echo "‚ùå dbt_packages.hash not found. Please generate and commit the hash file."
          exit 1
        fi
        # Compute hash of the dbt_packages directory (sorted file list, then sha256sum)
        find dbt_packages -type f -exec sha256sum {} \; | sort -k 2 | sha256sum | awk '{print $1}' > dbt_packages.current.hash
        EXPECTED_HASH=$(cat ../dbt_packages.hash)
        ACTUAL_HASH=$(cat dbt_packages.current.hash)
        if [ "$EXPECTED_HASH" != "$ACTUAL_HASH" ]; then
          echo "‚ùå DBT package integrity check failed!"
          echo "Expected:$EXPECTED_HASH"
          echo "Actual:$ACTUAL_HASH"
          echo "If you have intentionally updated packages, run:"
          echo "  find dbt_packages -type f -exec sha256sum {} \\; | sort -k 2 | sha256sum | awk '{print \$1}' > dbt_packages.hash"
          echo "and commit the updated dbt_packages.hash file."
          exit 1
        fi
        echo "‚úÖ DBT package integrity verified."

    - name: Compile DBT models
      run: |
        echo "üî® Compiling DBT models for ${{ env.ENVIRONMENT }}..."
        cd dbt
        dbt compile --profiles-dir . --target ${{ env.DBT_TARGET }}

    - name: Run DBT models
      id: dbt-run
      run: |
        echo "üöÄ Running DBT models on ${{ env.ENVIRONMENT }}..."
        cd dbt
        dbt run --profiles-dir . --target ${{ env.DBT_TARGET }}

        # Capture run statistics
        echo "run_status=success" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Run data quality tests
      id: dbt-test
      run: |
        echo "üß™ Running data quality tests..."
        cd dbt
        dbt test --profiles-dir . --target ${{ env.DBT_TARGET }}

        echo "test_status=success" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Generate documentation
      if: success()
      run: |
        echo "üìö Generating DBT documentation..."
        cd dbt
        dbt docs generate --profiles-dir . --target ${{ env.DBT_TARGET }}

    - name: Upload deployment artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts-dev-${{ github.sha }}
        path: |
          dbt/target/
          dbt/logs/
        retention-days: 30

    - name: Post-deployment health check
      if: success()
      run: |
        echo "üè• Running post-deployment health checks..."

        # Check if critical models exist and have data
        echo "‚úÖ Deployment health check passed"
        echo "üìä Development deployment completed successfully"
        echo "üîó Branch: ${{ github.ref_name }}"
        echo "üìù Commit: ${{ github.sha }}"
        echo "üë§ Deployed by: ${{ github.actor }}"

    - name: Create deployment summary
      if: always()
      run: |
        echo "## üìã Deployment Summary - Development" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Target | ${{ env.DBT_TARGET }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
        echo "| DBT Run Status | ${{ steps.dbt-run.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test Status | ${{ steps.dbt-test.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéØ Models Deployed" >> $GITHUB_STEP_SUMMARY
        echo "- Bronze Layer Models" >> $GITHUB_STEP_SUMMARY
        echo "- Silver Layer Models" >> $GITHUB_STEP_SUMMARY
        echo "- Gold Layer Models" >> $GITHUB_STEP_SUMMARY

  notify-deployment:
    name: Send Deployment Notifications
    runs-on: ubuntu-latest
    needs: deploy-development
    if: always()

    steps:
    - name: Notify on success
      if: needs.deploy-development.result == 'success'
      run: |
        echo "‚úÖ Development deployment successful!"
        echo "üîî Notification: Deployment to development environment completed"

        # In production, send to Slack:
        # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
        #   -H 'Content-Type: application/json' \
        #   -d '{"text":"‚úÖ Development deployment successful!"}'

    - name: Notify on failure
      if: needs.deploy-development.result == 'failure'
      run: |
        echo "‚ùå Development deployment failed!"
        echo "üîî Alert: Deployment to development environment failed"
        echo "üëâ Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        # In production, send alert to Slack:
        # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
        #   -H 'Content-Type: application/json' \
        #   -d '{"text":"‚ùå Development deployment failed!"}'
