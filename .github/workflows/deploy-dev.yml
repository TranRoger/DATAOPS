name: Deploy to Development

on:
  push:
    branches:
    - develop
  workflow_dispatch:
    # Allow manual trigger

env:
  ENVIRONMENT: development
  DBT_TARGET: dev

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Validate project structure
      run: |
        echo "üîç Validating project structure..."

        # Check required files
        for file in "docker-compose.yml" "dbt/dbt_project.yml" "airflow/dags/dbt_dag.py"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Required file not found: $file"
            exit 1
          fi
        done

        # Check required directories
        for dir in "dbt/models/bronze" "dbt/models/silver" "dbt/models/gold" "sqlserver"; do
          if [ ! -d "$dir" ]; then
            echo "‚ùå Required directory not found: $dir"
            exit 1
          fi
        done

        echo "‚úÖ Project structure is valid"

    - name: Check for breaking changes
      run: |
        echo "üîç Checking for breaking changes..."

        if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
          DELETED_MODELS=$(git diff --name-status HEAD~1 HEAD | grep "^D.*\.sql$" | wc -l)
          if [ "$DELETED_MODELS" -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: $DELETED_MODELS model(s) deleted"
            git diff --name-status HEAD~1 HEAD | grep "^D.*\.sql$" || true
          fi
        fi

        echo "‚úÖ Pre-deployment checks passed"

  deploy-development:
    name: Deploy to Development Environment
    runs-on: self-hosted
    needs: pre-deployment-checks
    environment:
      name: development

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Create profiles.yml from secret
      run: |
        echo "${{ secrets.DBT_PROFILE }}" > dbt/profiles.yml

    - name: Stop existing containers
      run: |
        echo "üõë Stopping existing containers..."
        docker-compose down --remove-orphans || true
        echo "‚úÖ Containers stopped"

    - name: Build containers
      run: |
        echo "üî® Building containers..."
        docker-compose build --no-cache
        echo "‚úÖ Containers built"

    - name: Start services
      run: |
        echo "üöÄ Starting services..."
        docker-compose up -d
        echo "‚úÖ Services started"

    - name: Wait for SQL Server to be ready
      run: |
        echo "‚è≥ Waiting for SQL Server to start (up to 2 minutes)..."
        for i in {1..60}; do
          if docker-compose exec -T sqlserver /opt/mssql-tools/bin/sqlcmd \
            -S localhost -U sa -P "YourStrong@Passw0rd" -Q "SELECT 1" &>/dev/null; then
            echo "‚úÖ SQL Server is ready!"
            break
          fi
          echo "Waiting for SQL Server... ($i/60)"
          sleep 2
        done

    - name: Initialize database
      run: |
        echo "üóÑÔ∏è Initializing AdventureWorks database..."
        docker-compose exec -T sqlserver /tmp/restore_db.sh || echo "Database may already exist"
        echo "‚úÖ Database initialized"

    - name: Configure DBT user
      run: |
        echo "üë§ Configuring DBT user..."
        docker-compose exec -T sqlserver /opt/mssql-tools/bin/sqlcmd \
          -S localhost -U sa -P "YourStrong@Passw0rd" -Q "
          IF NOT EXISTS (SELECT * FROM sys.server_principals WHERE name = 'imrandbtnew')
          BEGIN
            CREATE LOGIN imrandbtnew WITH PASSWORD = 'Imran@12345';
          END

          USE AdventureWorks2014;

          IF NOT EXISTS (SELECT * FROM sys.database_principals WHERE name = 'imrandbtnew')
          BEGIN
            CREATE USER imrandbtnew FOR LOGIN imrandbtnew;
            ALTER ROLE db_owner ADD MEMBER imrandbtnew;
          END
        "
        echo "‚úÖ DBT user configured"

    - name: Install DBT dependencies
      run: |
        echo "üì¶ Installing DBT dependencies..."
        docker-compose exec -T dbt dbt deps
        echo "‚úÖ DBT dependencies installed"

    - name: Verify DBT connection
      run: |
        echo "üîç Verifying DBT connection..."
        docker-compose exec -T dbt dbt debug
        echo "‚úÖ DBT connection verified"

    - name: Wait for Airflow to be ready
      run: |
        echo "‚è≥ Waiting for Airflow to be ready..."
        sleep 30
        for i in {1..30}; do
          if curl -s http://localhost:8080/health | grep -q "healthy"; then
            echo "‚úÖ Airflow is ready!"
            break
          fi
          echo "Waiting for Airflow... ($i/30)"
          sleep 5
        done

    - name: Run DBT models - Bronze layer
      id: dbt-bronze
      run: |
        echo "ü•â Running Bronze layer models..."
        docker-compose exec -T dbt dbt run --models bronze --profiles-dir /usr/app/dbt
        echo "‚úÖ Bronze layer completed"

    - name: Test Bronze layer
      run: |
        echo "üß™ Testing Bronze layer..."
        docker-compose exec -T dbt dbt test --models bronze --profiles-dir /usr/app/dbt
        echo "‚úÖ Bronze tests passed"

    - name: Run DBT models - Silver layer
      id: dbt-silver
      run: |
        echo "ü•à Running Silver layer models..."
        docker-compose exec -T dbt dbt run --models silver --profiles-dir /usr/app/dbt
        echo "‚úÖ Silver layer completed"

    - name: Test Silver layer
      run: |
        echo "üß™ Testing Silver layer..."
        docker-compose exec -T dbt dbt test --models silver --profiles-dir /usr/app/dbt
        echo "‚úÖ Silver tests passed"

    - name: Run DBT models - Gold layer
      id: dbt-gold
      run: |
        echo "ü•á Running Gold layer models..."
        docker-compose exec -T dbt dbt run --models gold --profiles-dir /usr/app/dbt
        echo "‚úÖ Gold layer completed"

    - name: Test Gold layer
      run: |
        echo "üß™ Testing Gold layer..."
        docker-compose exec -T dbt dbt test --models gold --profiles-dir /usr/app/dbt
        echo "‚úÖ Gold tests passed"

    - name: Generate DBT documentation
      run: |
        echo "üìö Generating DBT documentation..."
        docker-compose exec -T dbt dbt docs generate --profiles-dir /usr/app/dbt
        echo "‚úÖ Documentation generated"

    - name: Verify Airflow DAG
      run: |
        echo "üîç Verifying Airflow DAG..."
        docker-compose exec -T airflow-webserver airflow dags list | grep -q "dbt_transform" && \
          echo "‚úÖ DAG dbt_transform is registered" || \
          echo "‚ö†Ô∏è DAG not found, check Airflow logs"

    - name: Post-deployment health check
      run: |
        echo "üè• Running post-deployment health checks..."

        # Check all containers are running
        docker-compose ps

        # Check SQL Server
        docker-compose exec -T sqlserver /opt/mssql-tools/bin/sqlcmd \
          -S localhost -U imrandbtnew -P "Imran@12345" \
          -Q "SELECT COUNT(*) as model_count FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA IN ('bronze', 'silver', 'gold')"

        echo "‚úÖ Post-deployment health check passed"

    - name: Create deployment summary
      if: always()
      run: |
        echo "## üìã Development Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéØ Deployment Steps" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Docker containers built and started" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ SQL Server initialized with AdventureWorks" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ DBT user configured" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Bronze layer models deployed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Silver layer models deployed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Gold layer models deployed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY

  notify-deployment:
    name: Send Deployment Notifications
    runs-on: ubuntu-latest
    needs: deploy-development
    if: always()

    steps:
    - name: Notify on success
      if: needs.deploy-development.result == 'success'
      run: |
        echo "‚úÖ Development deployment successful!"
        # Uncomment to enable Slack notifications:
        # curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
        #   -H 'Content-Type: application/json' \
        #   -d '{"text":"‚úÖ Development deployment successful! Commit: ${{ github.sha }}"}'

    - name: Notify on failure
      if: needs.deploy-development.result == 'failure'
      run: |
        echo "‚ùå Development deployment failed!"
        echo "üëâ Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        # Uncomment to enable Slack notifications:
        # curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
        #   -H 'Content-Type: application/json' \
        #   -d '{"text":"‚ùå Development deployment failed! Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
