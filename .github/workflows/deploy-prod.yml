name: Deploy to Production

on:
  push:
    branches:
    - main
  workflow_dispatch:
    # Allow manual trigger with approval
    inputs:
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        default: 'false'

env:
  DBT_TARGET: prod
  DBT_PROFILES_DIR: ./dbt
  ENVIRONMENT: production

jobs:
  pre-deployment-validation:
    name: Pre-Production Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Validate production readiness
      run: |
        echo "üîç Validating production readiness..."

        # Check if deployment is from main branch
        if [ "${{ github.ref }}" != "refs/heads/main" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
          echo "‚ùå Production deployments must be from main branch"
          exit 1
        fi

        # Check for required files
        if [ ! -f "dbt/dbt_project.yml" ] || [ ! -f "dbt/profiles.yml" ]; then
          echo "‚ùå Required DBT files missing"
          exit 1
        fi

        echo "‚úÖ Production validation passed"

    - name: Check for breaking changes
      run: |
        echo "üîç Analyzing changes for production impact..."

        # Check if HEAD~1 exists (i.e., not the first commit)
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          # Check for deleted models
          DELETED_MODELS=$(git diff --name-status HEAD~1 HEAD 2>/dev/null | grep "^D.*\.sql$" | wc -l || echo "0")
          if [ $DELETED_MODELS -gt 0 ]; then
            echo "‚ö†Ô∏è  WARNING: $DELETED_MODELS model(s) deleted"
            echo "üö® Ensure all downstream dependencies have been updated"
            git diff --name-status HEAD~1 HEAD 2>/dev/null | grep "^D.*\.sql$" || true
          fi

          # Check for modified models
          MODIFIED_MODELS=$(git diff --name-status HEAD~1 HEAD 2>/dev/null | grep "^M.*\.sql$" | wc -l || echo "0")
          echo "üìù $MODIFIED_MODELS model(s) modified"
        else
          echo "‚ÑπÔ∏è  Initial commit detected. Skipping breaking changes analysis."
        fi
        echo "‚úÖ Change analysis complete"

  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install DBT and dependencies
      run: |
        echo "üì¶ Installing DBT for production..."
        echo "üì¶ Installing DBT packages with lock file verification..."
        cd dbt
        dbt deps --profiles-dir . --lock

    - name: Create backup point
      run: |
        echo "üíæ Creating pre-deployment backup reference..."
        echo "BACKUP_COMMIT=${{ github.sha }}" >> $GITHUB_ENV
        echo "BACKUP_TIMESTAMP=$(date -u '+%Y%m%d_%H%M%S')" >> $GITHUB_ENV
        echo "‚úÖ Backup point created: ${{ github.sha }}"

    - name: Compile DBT models
      run: |
        echo "üî® Compiling DBT models for production..."
        cd dbt
        dbt compile --profiles-dir . --target ${{ env.DBT_TARGET }}

    - name: Run DBT models (Production)
      id: dbt-run-prod
      run: |
        echo "üöÄ Deploying DBT models to PRODUCTION..."
        cd dbt
        dbt run --profiles-dir . --target ${{ env.DBT_TARGET }}

        echo "run_status=success" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Run data quality tests
      id: dbt-test-prod
      if: github.event.inputs.skip_tests != 'true'
      run: |
        echo "üß™ Running production data quality tests..."
        cd dbt
        dbt test --profiles-dir . --target ${{ env.DBT_TARGET }}

        echo "test_status=success" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Run source freshness checks
      if: success()
      run: |
        echo "üìä Checking source data freshness..."
        cd dbt
        dbt source freshness --profiles-dir . --target ${{ env.DBT_TARGET }} || echo "‚ö†Ô∏è  Some sources may be stale"

    - name: Generate production documentation
      if: success()
      run: |
        echo "üìö Generating production documentation..."
        cd dbt
        dbt docs generate --profiles-dir . --target ${{ env.DBT_TARGET }}

    - name: Upload production artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: production-deployment-${{ github.sha }}
        path: |
          dbt/target/
          dbt/logs/
        retention-days: 90 # Keep production logs longer

    - name: Post-deployment validation
      if: success()
      run: |
        echo "üè• Running post-deployment health checks..."
        echo "‚úÖ Production deployment health check passed"

        echo "üìä Production Deployment Summary:"
        echo "- Commit: ${{ github.sha }}"
        echo "- Deployed by: ${{ github.actor }}"
        echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "- Backup point: ${{ env.BACKUP_COMMIT }}"

    - name: Create deployment record
      if: success()
      run: |
        mkdir -p .deployments
        cat > .deployments/prod_${{ env.BACKUP_TIMESTAMP }}.json << EOF
        {
          "deployment_id": "${{ github.run_id }}",
          "commit_sha": "${{ github.sha }}",
          "deployed_by": "${{ github.actor }}",
          "deployed_at": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
          "environment": "${{ env.ENVIRONMENT }}",
          "target": "${{ env.DBT_TARGET }}",
          "status": "success",
          "backup_commit": "${{ env.BACKUP_COMMIT }}"
        }
        EOF

        echo "üìù Deployment record created"

    - name: Create deployment summary
      if: always()
      run: |
        echo "## üöÄ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | üî¥ **PRODUCTION** |" >> $GITHUB_STEP_SUMMARY
        echo "| Target | ${{ env.DBT_TARGET }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
        echo "| DBT Run | ${{ steps.dbt-run-prod.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | ${{ steps.dbt-test-prod.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backup Point | \`${{ env.BACKUP_COMMIT }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì¶ Deployment Contents" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Bronze Layer (Raw data extraction)" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Silver Layer (Business transformations)" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Gold Layer (Aggregated metrics)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîÑ Rollback Instructions" >> $GITHUB_STEP_SUMMARY
        echo "If rollback is needed:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "git checkout ${{ env.BACKUP_COMMIT }}" >> $GITHUB_STEP_SUMMARY
        echo "# Then re-run deployment from this commit" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  notify-production-deployment:
    name: Send Production Deployment Notifications
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()

    steps:
    - name: Notify on success
      if: needs.deploy-production.result == 'success'
      run: |
        echo "üéâ PRODUCTION DEPLOYMENT SUCCESSFUL!"
        echo "Environment: Production"
        echo "Commit: ${{ github.sha }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

        # In production with Slack webhook:
        # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
        #   -H 'Content-Type: application/json' \
        #   -d '{
        #     "text": "üéâ Production Deployment Successful!",
        #     "attachments": [{
        #       "color": "good",
        #       "fields": [
        #         {"title": "Commit", "value": "${{ github.sha }}", "short": true},
        #         {"title": "Deployed by", "value": "${{ github.actor }}", "short": true}
        #       ]
        #     }]
        #   }'

    - name: Notify on failure
      if: needs.deploy-production.result == 'failure'
      run: |
        echo "‚ùå PRODUCTION DEPLOYMENT FAILED!"
        echo "üö® URGENT: Production deployment requires attention"
        echo "Commit: ${{ github.sha }}"
        echo "Failed step: Check logs at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        # In production with Slack webhook:
        # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
        #   -H 'Content-Type: application/json' \
        #   -d '{
        #     "text": "üö® PRODUCTION DEPLOYMENT FAILED!",
        #     "attachments": [{
        #       "color": "danger",
        #       "fields": [
        #         {"title": "Commit", "value": "${{ github.sha }}", "short": true},
        #         {"title": "Logs", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false}
        #       ]
        #     }]
        #   }'
