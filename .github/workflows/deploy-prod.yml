name: Deploy to Production

on:
  push:
    branches:
    - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        default: 'false'
      force_rebuild:
        description: 'Force rebuild containers'
        required: false
        default: 'false'

env:
  ENVIRONMENT: production
  DBT_TARGET: prod

jobs:
  pre-deployment-validation:
    name: Pre-Production Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Validate production readiness
      run: |
        echo "üîç Validating production readiness..."

        # Check if deployment is from main branch
        if [ "${{ github.ref }}" != "refs/heads/main" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
          echo "‚ùå Production deployments must be from main branch"
          exit 1
        fi

        # Check required files
        for file in "docker-compose.yml" "dbt/dbt_project.yml" "airflow/dags/dbt_dag.py"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Required file not found: $file"
            exit 1
          fi
        done

        echo "‚úÖ Production validation passed"

    - name: Check for breaking changes
      run: |
        echo "üîç Analyzing changes for production impact..."

        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          DELETED_MODELS=$(git diff --name-status HEAD~1 HEAD | grep "^D.*\.sql$" | wc -l || echo "0")
          if [ "$DELETED_MODELS" -gt 0 ]; then
            echo "‚ö†Ô∏è  WARNING: $DELETED_MODELS model(s) deleted"
            echo "üö® Ensure all downstream dependencies have been updated"
            git diff --name-status HEAD~1 HEAD | grep "^D.*\.sql$" || true
          fi

          MODIFIED_MODELS=$(git diff --name-status HEAD~1 HEAD | grep "^M.*\.sql$" | wc -l || echo "0")
          echo "üìù $MODIFIED_MODELS model(s) modified"
        fi

        echo "‚úÖ Change analysis complete"

  deploy-production:
    name: Deploy to Production Environment
    runs-on: self-hosted
    needs: pre-deployment-validation
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Create profiles.yml from secret
      run: |
        echo "${{ secrets.DBT_PROFILE }}" > dbt/profiles.yml

    - name: Create backup point
      run: |
        echo "üíæ Creating pre-deployment backup reference..."
        echo "BACKUP_COMMIT=${{ github.sha }}" >> $GITHUB_ENV
        echo "BACKUP_TIMESTAMP=$(date -u '+%Y%m%d_%H%M%S')" >> $GITHUB_ENV

        # Backup current database state if containers are running
        if docker-compose ps | grep -q "sqlserver.*Up"; then
          echo "üì¶ Creating database backup..."
          docker-compose exec -T sqlserver /opt/mssql-tools/bin/sqlcmd \
            -S localhost -U sa -P "YourStrong@Passw0rd" -Q "
            BACKUP DATABASE AdventureWorks2014
            TO DISK = '/var/opt/mssql/backup/AdventureWorks2014_$(date +%Y%m%d_%H%M%S).bak'
            WITH FORMAT, COMPRESSION
          " || echo "‚ö†Ô∏è Backup skipped - first deployment"
        fi

        echo "‚úÖ Backup point created: ${{ github.sha }}"

    - name: Stop existing containers
      run: |
        echo "üõë Stopping existing containers..."
        docker-compose down --remove-orphans || true
        echo "‚úÖ Containers stopped"

    - name: Build containers
      env:
        FORCE_REBUILD: ${{ github.event.inputs.force_rebuild }}
      run: |
        echo "üî® Building containers..."
        if [ "$FORCE_REBUILD" == "true" ]; then
          docker-compose build --no-cache
        else
          docker-compose build
        fi
        echo "‚úÖ Containers built"

    - name: Start services
      run: |
        echo "üöÄ Starting services..."
        docker-compose up -d
        echo "‚úÖ Services started"

    - name: Wait for SQL Server to be ready
      run: |
        echo "‚è≥ Waiting for SQL Server to start (up to 3 minutes)..."
        for i in {1..90}; do
          if docker-compose exec -T sqlserver /opt/mssql-tools/bin/sqlcmd \
            -S localhost -U sa -P "YourStrong@Passw0rd" -Q "SELECT 1" &>/dev/null; then
            echo "‚úÖ SQL Server is ready!"
            break
          fi
          echo "Waiting for SQL Server... ($i/90)"
          sleep 2
        done

    - name: Initialize database
      run: |
        echo "üóÑÔ∏è Initializing AdventureWorks database..."
        docker-compose exec -T sqlserver /tmp/restore_db.sh || echo "Database may already exist"
        echo "‚úÖ Database initialized"

    - name: Configure DBT user
      run: |
        echo "üë§ Configuring DBT user..."
        docker-compose exec -T sqlserver /opt/mssql-tools/bin/sqlcmd \
          -S localhost -U sa -P "YourStrong@Passw0rd" -Q "
          IF NOT EXISTS (SELECT * FROM sys.server_principals WHERE name = 'imrandbtnew')
          BEGIN
            CREATE LOGIN imrandbtnew WITH PASSWORD = 'Imran@12345';
          END

          USE AdventureWorks2014;

          IF NOT EXISTS (SELECT * FROM sys.database_principals WHERE name = 'imrandbtnew')
          BEGIN
            CREATE USER imrandbtnew FOR LOGIN imrandbtnew;
            ALTER ROLE db_owner ADD MEMBER imrandbtnew;
          END
        "
        echo "‚úÖ DBT user configured"

    - name: Install DBT dependencies
      run: |
        echo "üì¶ Installing DBT dependencies..."
        docker-compose exec -T dbt dbt deps
        echo "‚úÖ DBT dependencies installed"

    - name: Verify DBT connection
      run: |
        echo "üîç Verifying DBT connection..."
        docker-compose exec -T dbt dbt debug
        echo "‚úÖ DBT connection verified"

    - name: Wait for Airflow to be ready
      run: |
        echo "‚è≥ Waiting for Airflow to be ready..."
        sleep 30
        for i in {1..30}; do
          if curl -s http://localhost:8080/health | grep -q "healthy"; then
            echo "‚úÖ Airflow is ready!"
            break
          fi
          echo "Waiting for Airflow... ($i/30)"
          sleep 5
        done

    - name: Run DBT models - Bronze layer
      id: dbt-bronze
      run: |
        echo "ü•â Running Bronze layer models..."
        docker-compose exec -T dbt dbt run --models bronze --profiles-dir /usr/app/dbt
        echo "‚úÖ Bronze layer completed"

    - name: Test Bronze layer
      if: github.event.inputs.skip_tests != 'true'
      run: |
        echo "üß™ Testing Bronze layer..."
        docker-compose exec -T dbt dbt test --models bronze --profiles-dir /usr/app/dbt
        echo "‚úÖ Bronze tests passed"

    - name: Run DBT models - Silver layer
      id: dbt-silver
      run: |
        echo "ü•à Running Silver layer models..."
        docker-compose exec -T dbt dbt run --models silver --profiles-dir /usr/app/dbt
        echo "‚úÖ Silver layer completed"

    - name: Test Silver layer
      if: github.event.inputs.skip_tests != 'true'
      run: |
        echo "üß™ Testing Silver layer..."
        docker-compose exec -T dbt dbt test --models silver --profiles-dir /usr/app/dbt
        echo "‚úÖ Silver tests passed"

    - name: Run DBT models - Gold layer
      id: dbt-gold
      run: |
        echo "ü•á Running Gold layer models..."
        docker-compose exec -T dbt dbt run --models gold --profiles-dir /usr/app/dbt
        echo "‚úÖ Gold layer completed"

    - name: Test Gold layer
      if: github.event.inputs.skip_tests != 'true'
      run: |
        echo "üß™ Testing Gold layer..."
        docker-compose exec -T dbt dbt test --models gold --profiles-dir /usr/app/dbt
        echo "‚úÖ Gold tests passed"

    - name: Run source freshness checks
      run: |
        echo "üìä Checking source data freshness..."
        docker-compose exec -T dbt dbt source freshness --profiles-dir /usr/app/dbt || echo "‚ö†Ô∏è Some sources may be stale"
        echo "‚úÖ Source freshness check completed"

    - name: Generate DBT documentation
      run: |
        echo "üìö Generating DBT documentation..."
        docker-compose exec -T dbt dbt docs generate --profiles-dir /usr/app/dbt
        echo "‚úÖ Documentation generated"

    - name: Verify Airflow DAG
      run: |
        echo "üîç Verifying Airflow DAG..."
        docker-compose exec -T airflow-webserver airflow dags list | grep -q "dbt_transform" && \
          echo "‚úÖ DAG dbt_transform is registered" || \
          echo "‚ö†Ô∏è DAG not found, check Airflow logs"

    - name: Post-deployment health check
      run: |
        echo "üè• Running post-deployment health checks..."

        # Check all containers are running
        docker-compose ps

        # Check SQL Server models
        docker-compose exec -T sqlserver /opt/mssql-tools/bin/sqlcmd \
          -S localhost -U imrandbtnew -P "Imran@12345" \
          -Q "SELECT COUNT(*) as model_count FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA IN ('bronze', 'silver', 'gold')"

        # Verify critical gold models exist
        docker-compose exec -T sqlserver /opt/mssql-tools/bin/sqlcmd \
          -S localhost -U imrandbtnew -P "Imran@12345" \
          -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'gold'"

        echo "‚úÖ Post-deployment health check passed"

    - name: Create deployment record
      if: success()
      run: |
        mkdir -p .deployments
        cat > .deployments/prod_${{ env.BACKUP_TIMESTAMP }}.json << EOF
        {
          "deployment_id": "${{ github.run_id }}",
          "commit_sha": "${{ github.sha }}",
          "deployed_by": "${{ github.actor }}",
          "deployed_at": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')",
          "environment": "${{ env.ENVIRONMENT }}",
          "target": "${{ env.DBT_TARGET }}",
          "status": "success",
          "backup_commit": "${{ env.BACKUP_COMMIT }}"
        }
        EOF
        echo "üìù Deployment record created"

    - name: Create deployment summary
      if: always()
      run: |
        echo "## üöÄ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | üî¥ **PRODUCTION** |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
        echo "| Backup Point | \`${{ env.BACKUP_COMMIT }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üéØ Deployment Steps" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Docker containers built and started" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ SQL Server initialized with AdventureWorks" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ DBT user configured" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Bronze layer models deployed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Silver layer models deployed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Gold layer models deployed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîÑ Rollback Instructions" >> $GITHUB_STEP_SUMMARY
        echo "If rollback is needed, use the rollback workflow or run:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "git checkout ${{ env.BACKUP_COMMIT }}" >> $GITHUB_STEP_SUMMARY
        echo "docker-compose down && docker-compose up -d" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  notify-production-deployment:
    name: Send Production Deployment Notifications
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()

    steps:
    - name: Notify on success
      if: needs.deploy-production.result == 'success'
      run: |
        echo "üéâ PRODUCTION DEPLOYMENT SUCCESSFUL!"
        echo "Environment: Production"
        echo "Commit: ${{ github.sha }}"
        echo "Deployed by: ${{ github.actor }}"
        # Uncomment to enable Slack notifications:
        # curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
        #   -H 'Content-Type: application/json' \
        #   -d '{
        #     "text": "üéâ Production Deployment Successful!",
        #     "attachments": [{
        #       "color": "good",
        #       "fields": [
        #         {"title": "Commit", "value": "${{ github.sha }}", "short": true},
        #         {"title": "Deployed by", "value": "${{ github.actor }}", "short": true}
        #       ]
        #     }]
        #   }'

    - name: Notify on failure
      if: needs.deploy-production.result == 'failure'
      run: |
        echo "‚ùå PRODUCTION DEPLOYMENT FAILED!"
        echo "üö® URGENT: Production deployment requires attention"
        echo "Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        # Uncomment to enable Slack notifications:
        # curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
        #   -H 'Content-Type: application/json' \
        #   -d '{
        #     "text": "üö® PRODUCTION DEPLOYMENT FAILED!",
        #     "attachments": [{
        #       "color": "danger",
        #       "fields": [
        #         {"title": "Commit", "value": "${{ github.sha }}", "short": true},
        #         {"title": "Logs", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false}
        #       ]
        #     }]
        #   }'
