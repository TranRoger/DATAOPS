name: Deploy DBT Pipeline

on:
  push:
    branches:
    - develop # Auto-deploy to development
    - main # Auto-deploy to production

env:
  DBT_PROFILES_DIR: ./dbt
  SA_PASSWORD: YourStrong@Passw0rd123

jobs:
  # ============================================
  # Pre-deployment Validation
  # ============================================
  pre-deploy-validation:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      target: ${{ steps.set-env.outputs.target }}

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: YourStrong@Passw0rd123
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd123 -C -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd123 -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Determine deployment environment
      id: set-env
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "target=prod" >> $GITHUB_OUTPUT
          echo "ðŸš€ Deploying to PRODUCTION environment"
        else
          echo "environment=development" >> $GITHUB_OUTPUT
          echo "target=dev" >> $GITHUB_OUTPUT
          echo "ðŸ”§ Deploying to DEVELOPMENT environment"
        fi

    - name: Install SQL Server tools
      run: |
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
        echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> ~/.bashrc

    - name: Wait for SQL Server to be ready
      run: |
        echo "â³ Waiting for SQL Server to be ready..."
        for i in {1..30}; do
          if /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -Q "SELECT 1" &>/dev/null; then
            echo "âœ… SQL Server is ready!"
            break
          fi
          echo "Waiting... attempt $i/30"
          sleep 5
        done

    - name: Setup database and user
      run: |
        echo "ðŸ”§ Creating database and user for DBT..."
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -Q "
          CREATE DATABASE AdventureWorks2014;
          GO
          USE AdventureWorks2014;
          GO
          CREATE LOGIN dbt_user WITH PASSWORD = 'DbtUser@12345';
          GO
          CREATE USER dbt_user FOR LOGIN dbt_user;
          GO
          ALTER ROLE db_owner ADD MEMBER dbt_user;
          GO
          -- Create schemas for medallion architecture
          CREATE SCHEMA bronze;
          GO
          CREATE SCHEMA silver;
          GO
          CREATE SCHEMA gold;
          GO
          CREATE SCHEMA dbo_dev;
          GO
          -- Grant permissions
          GRANT CREATE TABLE TO dbt_user;
          GRANT CREATE VIEW TO dbt_user;
          GO
        "
        echo "âœ… Database and user created successfully"

    - name: Create source tables for DBT
      run: |
        echo "ðŸ“Š Creating source tables..."
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -d AdventureWorks2014 -Q "
          -- Create Sales schema
          IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'Sales')
            EXEC('CREATE SCHEMA Sales');
          GO

          -- Create sample SalesOrderHeader table
          CREATE TABLE Sales.SalesOrderHeader (
            SalesOrderID INT PRIMARY KEY IDENTITY(1,1),
            OrderDate DATETIME DEFAULT GETDATE(),
            DueDate DATETIME,
            ShipDate DATETIME,
            Status TINYINT DEFAULT 1,
            CustomerID INT,
            TotalDue MONEY,
            ModifiedDate DATETIME DEFAULT GETDATE()
          );
          GO

          -- Create sample SalesOrderDetail table
          CREATE TABLE Sales.SalesOrderDetail (
            SalesOrderDetailID INT PRIMARY KEY IDENTITY(1,1),
            SalesOrderID INT,
            ProductID INT,
            OrderQty SMALLINT,
            UnitPrice MONEY,
            LineTotal AS (OrderQty * UnitPrice),
            ModifiedDate DATETIME DEFAULT GETDATE()
          );
          GO

          -- Create sample Customer table
          CREATE TABLE Sales.Customer (
            CustomerID INT PRIMARY KEY IDENTITY(1,1),
            PersonID INT,
            StoreID INT,
            AccountNumber VARCHAR(20),
            ModifiedDate DATETIME DEFAULT GETDATE()
          );
          GO

          -- Insert sample data
          INSERT INTO Sales.Customer (PersonID, StoreID, AccountNumber)
          VALUES (1, 100, 'AW00000001'), (2, 101, 'AW00000002'), (3, 102, 'AW00000003');

          INSERT INTO Sales.SalesOrderHeader (OrderDate, DueDate, ShipDate, CustomerID, TotalDue)
          VALUES
            (GETDATE(), DATEADD(day, 7, GETDATE()), DATEADD(day, 3, GETDATE()), 1, 1500.00),
            (GETDATE(), DATEADD(day, 7, GETDATE()), DATEADD(day, 3, GETDATE()), 2, 2500.00),
            (GETDATE(), DATEADD(day, 7, GETDATE()), NULL, 3, 3500.00);

          INSERT INTO Sales.SalesOrderDetail (SalesOrderID, ProductID, OrderQty, UnitPrice)
          VALUES (1, 101, 2, 750.00), (2, 102, 5, 500.00), (3, 103, 7, 500.00);

          PRINT 'Sample data inserted successfully';
        "
        echo "âœ… Source tables created with sample data"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install DBT
      run: |
        echo "ðŸ“¦ Installing DBT from requirements.txt..."
        pip install -r dbt/requirements.txt

    - name: Create CI profiles.yml
      run: |
        cat > dbt/profiles.yml << 'EOF'
        dbt_airflow_project:
          target: dev
          outputs:
            dev:
              type: sqlserver
              driver: 'ODBC Driver 18 for SQL Server'
              server: localhost
              port: 1433
              database: AdventureWorks2014
              schema: dbo_dev
              user: dbt_user
              password: 'DbtUser@12345'
              encrypt: true
              trust_cert: true
              threads: 4
            prod:
              type: sqlserver
              driver: 'ODBC Driver 18 for SQL Server'
              server: localhost
              port: 1433
              database: AdventureWorks2014
              schema: dbo
              user: dbt_user
              password: 'DbtUser@12345'
              encrypt: true
              trust_cert: true
              threads: 2
        EOF
        echo "âœ… CI profiles.yml created"

    - name: Install DBT dependencies
      run: |
        cd dbt
        echo "ðŸ“¦ Installing DBT packages..."
        dbt deps --profiles-dir .

    - name: Validate DBT project
      run: |
        cd dbt
        echo "ðŸ” Validating DBT project structure..."
        dbt debug --profiles-dir .
        echo "âœ… DBT project validation passed"

    - name: Compile models (dry run)
      run: |
        cd dbt
        echo "ðŸ”„ Compiling DBT models..."
        dbt compile --profiles-dir .
        echo "âœ… DBT models compiled successfully"

    - name: Pre-deployment Summary
      run: |
        echo "## ðŸ” Pre-deployment Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ steps.set-env.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Target | ${{ steps.set-env.outputs.target }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| DBT Validation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| DBT Compile | âœ… Passed |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy DBT Models
  # ============================================
  deploy:
    name: Deploy to ${{ needs.pre-deploy-validation.outputs.environment }}
    runs-on: ubuntu-latest
    needs: pre-deploy-validation
    environment:
      name: ${{ needs.pre-deploy-validation.outputs.environment }}

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: YourStrong@Passw0rd123
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd123 -C -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd123 -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install SQL Server tools
      run: |
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev

    - name: Wait for SQL Server and setup database
      run: |
        echo "â³ Waiting for SQL Server..."
        for i in {1..30}; do
          if /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -Q "SELECT 1" &>/dev/null; then
            echo "âœ… SQL Server is ready!"
            break
          fi
          sleep 5
        done

        echo "ðŸ”§ Setting up database..."
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -Q "
          CREATE DATABASE AdventureWorks2014;
        "
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -d AdventureWorks2014 -Q "
          CREATE LOGIN dbt_user WITH PASSWORD = 'DbtUser@12345';
          CREATE USER dbt_user FOR LOGIN dbt_user;
          ALTER ROLE db_owner ADD MEMBER dbt_user;
          CREATE SCHEMA bronze;
          CREATE SCHEMA silver;
          CREATE SCHEMA gold;
          CREATE SCHEMA dbo_dev;
        "

        echo "ðŸ“Š Creating source tables..."
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -d AdventureWorks2014 -Q "
          CREATE SCHEMA Sales;
        "
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -d AdventureWorks2014 -Q "
          CREATE TABLE Sales.SalesOrderHeader (
            SalesOrderID INT PRIMARY KEY IDENTITY(1,1),
            OrderDate DATETIME DEFAULT GETDATE(),
            DueDate DATETIME,
            ShipDate DATETIME,
            Status TINYINT DEFAULT 1,
            CustomerID INT,
            TotalDue MONEY,
            ModifiedDate DATETIME DEFAULT GETDATE()
          );
          CREATE TABLE Sales.SalesOrderDetail (
            SalesOrderDetailID INT PRIMARY KEY IDENTITY(1,1),
            SalesOrderID INT,
            ProductID INT,
            OrderQty SMALLINT,
            UnitPrice MONEY,
            LineTotal AS (OrderQty * UnitPrice),
            ModifiedDate DATETIME DEFAULT GETDATE()
          );
          CREATE TABLE Sales.Customer (
            CustomerID INT PRIMARY KEY IDENTITY(1,1),
            PersonID INT,
            StoreID INT,
            AccountNumber VARCHAR(20),
            ModifiedDate DATETIME DEFAULT GETDATE()
          );
          INSERT INTO Sales.Customer (PersonID, StoreID, AccountNumber)
          VALUES (1, 100, 'AW00000001'), (2, 101, 'AW00000002'), (3, 102, 'AW00000003');
          INSERT INTO Sales.SalesOrderHeader (OrderDate, DueDate, ShipDate, CustomerID, TotalDue)
          VALUES
            (GETDATE(), DATEADD(day, 7, GETDATE()), DATEADD(day, 3, GETDATE()), 1, 1500.00),
            (GETDATE(), DATEADD(day, 7, GETDATE()), DATEADD(day, 3, GETDATE()), 2, 2500.00),
            (GETDATE(), DATEADD(day, 7, GETDATE()), NULL, 3, 3500.00);
          INSERT INTO Sales.SalesOrderDetail (SalesOrderID, ProductID, OrderQty, UnitPrice)
          VALUES (1, 101, 2, 750.00), (2, 102, 5, 500.00), (3, 103, 7, 500.00);
        "
        echo "âœ… Database setup complete"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install DBT
      run: |
        echo "ðŸ“¦ Installing DBT from requirements.txt..."
        pip install -r dbt/requirements.txt

    - name: Create CI profiles.yml
      run: |
        cat > dbt/profiles.yml << 'EOF'
        dbt_airflow_project:
          target: dev
          outputs:
            dev:
              type: sqlserver
              driver: 'ODBC Driver 18 for SQL Server'
              server: localhost
              port: 1433
              database: AdventureWorks2014
              schema: dbo_dev
              user: dbt_user
              password: 'DbtUser@12345'
              encrypt: true
              trust_cert: true
              threads: 4
            prod:
              type: sqlserver
              driver: 'ODBC Driver 18 for SQL Server'
              server: localhost
              port: 1433
              database: AdventureWorks2014
              schema: dbo
              user: dbt_user
              password: 'DbtUser@12345'
              encrypt: true
              trust_cert: true
              threads: 2
        EOF

    - name: Install DBT dependencies
      id: dbt-deps
      run: |
        cd dbt
        echo "ðŸ“¦ Installing DBT packages..."
        dbt deps --profiles-dir .
        echo "âœ… DBT dependencies installed"

    - name: Run DBT models
      id: dbt-run
      run: |
        cd dbt
        echo "ðŸ”„ Running DBT models for ${{ needs.pre-deploy-validation.outputs.environment }}..."
        dbt run --profiles-dir . --target ${{ needs.pre-deploy-validation.outputs.target }} 2>&1 | tee dbt_run.log
        echo "âœ… DBT models executed successfully"

    - name: Execute data quality tests
      id: dbt-test
      run: |
        cd dbt
        echo "ðŸ§ª Running data quality tests..."
        dbt test --profiles-dir . --target ${{ needs.pre-deploy-validation.outputs.target }} 2>&1 | tee dbt_test.log
        echo "âœ… Data quality tests passed"

    - name: Generate DBT documentation
      run: |
        cd dbt
        echo "ðŸ“š Generating DBT documentation..."
        dbt docs generate --profiles-dir . --target ${{ needs.pre-deploy-validation.outputs.target }}
        echo "âœ… Documentation generated"

    - name: Upload deployment logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: deployment-logs-${{ needs.pre-deploy-validation.outputs.environment }}-${{ github.run_number }}
        path: |
          dbt/dbt_run.log
          dbt/dbt_test.log
          dbt/target/run_results.json
          dbt/target/manifest.json
        retention-days: 30

    - name: Deployment Summary
      if: success()
      run: |
        echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | **${{ needs.pre-deploy-validation.outputs.environment }}** |" >> $GITHUB_STEP_SUMMARY
        echo "| Target | ${{ needs.pre-deploy-validation.outputs.target }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Run Number | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Deployment Steps Completed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] DBT dependencies installed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] DBT models executed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Data quality tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Documentation generated" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Post-deployment Health Checks
  # ============================================
  post-deploy-health-check:
    name: Post-deployment Health Check
    runs-on: ubuntu-latest
    needs: [ pre-deploy-validation, deploy ]
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download deployment artifacts
      uses: actions/download-artifact@v4
      with:
        name: deployment-logs-${{ needs.pre-deploy-validation.outputs.environment }}-${{ github.run_number }}
        path: deployment-artifacts

    - name: Verify deployment artifacts
      run: |
        echo "ðŸ¥ Verifying deployment artifacts..."
        ls -la deployment-artifacts/

        if [ -f "deployment-artifacts/run_results.json" ]; then
          echo "âœ… run_results.json found"
          # Check for any failures in run results
          if grep -q '"status": "error"' deployment-artifacts/run_results.json 2>/dev/null; then
            echo "âŒ Found errors in run results"
            exit 1
          fi
        fi

        if [ -f "deployment-artifacts/dbt_run.log" ]; then
          echo "âœ… dbt_run.log found"
          echo "ðŸ“‹ Last 20 lines of run log:"
          tail -20 deployment-artifacts/dbt_run.log
        fi

        if [ -f "deployment-artifacts/dbt_test.log" ]; then
          echo "âœ… dbt_test.log found"
          echo "ðŸ“‹ Last 20 lines of test log:"
          tail -20 deployment-artifacts/dbt_test.log
        fi

        echo "âœ… Health checks completed"

    - name: Health Check Summary
      run: |
        echo "## ðŸ¥ Post-deployment Health Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Deployment Artifacts | âœ… Verified |" >> $GITHUB_STEP_SUMMARY
        echo "| Run Results | âœ… No Errors |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployment | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deployment Notification
  # ============================================
  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [ pre-deploy-validation, deploy, post-deploy-health-check ]
    if: always()

    steps:
    - name: Deployment Success Notification
      if: needs.deploy.result == 'success'
      run: |
        echo "## ðŸŽ‰ Deployment Notification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ needs.pre-deploy-validation.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

    - name: Deployment Failure Notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment to ${{ needs.pre-deploy-validation.outputs.environment }} failed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Rollback Instructions" >> $GITHUB_STEP_SUMMARY
        echo "If needed, trigger a manual rollback using the [Rollback Workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/rollback.yml)" >> $GITHUB_STEP_SUMMARY

    - name: Create deployment comment on commit
      if: needs.deploy.result == 'success'
      uses: actions/github-script@v6
      with:
        script: |
          const environment = '${{ needs.pre-deploy-validation.outputs.environment }}';
          const emoji = environment === 'production' ? 'ðŸš€' : 'ðŸ”§';

          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `${emoji} **Deployment Successful**\n\n` +
                  `- **Environment:** ${environment}\n` +
                  `- **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n` +
                  `- **Timestamp:** ${new Date().toISOString()}`
          });
