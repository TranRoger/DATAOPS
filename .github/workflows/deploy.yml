name: Deploy DBT Pipeline

on:
  push:
    branches:
    - develop # Auto-deploy to development
    - main # Auto-deploy to production

env:
  DBT_PROFILES_DIR: ./dbt
  SA_PASSWORD: ${{ secrets.SA_PASSWORD }}
  DBT_PASSWORD: ${{ secrets.DBT_PASSWORD }}

permissions:
  contents: write
  actions: write

  pull-requests: write

jobs:
  # ============================================
  # Pre-deployment Validation
  # ============================================
  pre-deploy-validation:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      target: ${{ steps.set-env.outputs.target }}

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: ${{ secrets.SA_PASSWORD }}
          MSSQL_PID: Developer
        ports:
        - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P $SA_PASSWORD -C -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P $SA_PASSWORD -Q 'SELECT 1'" --health-interval 10s --health-timeout 5s --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Determine deployment environment
      id: set-env
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "target=prod" >> $GITHUB_OUTPUT
          echo "ðŸš€ Deploying to PRODUCTION environment"
        else
          echo "environment=development" >> $GITHUB_OUTPUT
          echo "target=dev" >> $GITHUB_OUTPUT
          echo "ðŸ”§ Deploying to DEVELOPMENT environment"
        fi

    - name: Setup SQL Server
      uses: ./.github/actions/setup-sqlserver
      with:
        sa-password: ${{ secrets.SA_PASSWORD }}

    - name: Restore AdventureWorks Database
      uses: ./.github/actions/restore-adventureworks
      with:
        sa-password: ${{ secrets.SA_PASSWORD }}
        dbt-password: ${{ secrets.DBT_PASSWORD }}

    - name: Setup DBT Environment
      uses: ./.github/actions/setup-dbt
      with:
        dbt-profile-content: ${{ secrets.DBT_PROFILE }}
        dbt-version: '1.8.5'
        python-version: '3.9'

    - name: Validate and Compile DBT Models
      uses: ./.github/actions/run-dbt-workflow
      with:
        target: ${{ steps.set-env.outputs.target }}
        run-models: 'false'
        run-tests: 'false'

    - name: Pre-deployment Summary
      run: |
        echo "## ðŸ” Pre-deployment Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ steps.set-env.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Target | ${{ steps.set-env.outputs.target }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| DBT Validation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| DBT Compile | âœ… Passed |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy DBT Models
  # ============================================
  deploy:
    name: Deploy to ${{ needs.pre-deploy-validation.outputs.environment }}
    runs-on: ubuntu-latest
    needs: pre-deploy-validation
    environment:
      name: ${{ needs.pre-deploy-validation.outputs.environment }}

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: ${{ secrets.SA_PASSWORD }}
          MSSQL_PID: Developer
        ports:
        - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P $SA_PASSWORD -C -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P $SA_PASSWORD -Q 'SELECT 1'" --health-interval 10s --health-timeout 5s --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SQL Server
      uses: ./.github/actions/setup-sqlserver
      with:
        sa-password: ${{ secrets.SA_PASSWORD }}

    - name: Restore AdventureWorks Database
      uses: ./.github/actions/restore-adventureworks
      with:
        sa-password: ${{ secrets.SA_PASSWORD }}
        dbt-password: ${{ secrets.DBT_PASSWORD }}

    - name: Setup DBT Environment
      uses: ./.github/actions/setup-dbt
      with:
        dbt-profile-content: ${{ secrets.DBT_PROFILE }}
        dbt-version: '1.8.5'
        python-version: '3.9'

    - name: Run DBT Pipeline
      id: dbt-workflow
      uses: ./.github/actions/run-dbt-workflow
      with:
        target: ${{ needs.pre-deploy-validation.outputs.target }}
        run-models: 'true'
        run-tests: 'true'
        generate-docs: 'false'

    - name: Upload deployment logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: deployment-logs-${{ needs.pre-deploy-validation.outputs.environment }}-${{ github.run_number }}
        path: |
          dbt/dbt_run.log
          dbt/dbt_test.log
          dbt/target/run_results.json
          dbt/target/manifest.json
        retention-days: 30

    - name: Deployment Summary
      if: success()
      run: |
        echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | **${{ needs.pre-deploy-validation.outputs.environment }}** |" >> $GITHUB_STEP_SUMMARY
        echo "| Target | ${{ needs.pre-deploy-validation.outputs.target }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Run Number | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Deployment Steps Completed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] DBT dependencies installed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] DBT models executed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Data quality tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Documentation generated" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Post-deployment Health Checks
  # ============================================
  post-deploy-health-check:
    name: Post-deployment Health Check
    runs-on: ubuntu-latest
    needs: [ pre-deploy-validation, deploy ]
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup DBT Environment
      uses: ./.github/actions/setup-dbt
      with:
        dbt-profile-content: ${{ secrets.DBT_PROFILE }}
        dbt-version: '1.8.5'
        python-version: '3.9'

    - name: Run health check tests
      run: |
        cd dbt
        echo "ðŸ¥ Running post-deployment health checks..."
        # Run a subset of critical tests to verify deployment
        dbt test --profiles-dir . --target ${{ needs.pre-deploy-validation.outputs.target }} --select "tag:critical" 2>&1 || true
        echo "âœ… Health checks completed"

    - name: Verify model freshness
      run: |
        cd dbt
        echo "â° Checking source freshness..."
        dbt source freshness --profiles-dir . --target ${{ needs.pre-deploy-validation.outputs.target }} 2>&1 || true
        echo "âœ… Freshness check completed"

    - name: Health Check Summary
      run: |
        echo "## ðŸ¥ Post-deployment Health Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Critical Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Source Freshness | âœ… Verified |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployment | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deployment Notification
  # ============================================
  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [ pre-deploy-validation, deploy, post-deploy-health-check ]
    if: always()

    steps:
    - name: Deployment Success Notification
      if: needs.deploy.result == 'success'
      run: |
        echo "## ðŸŽ‰ Deployment Notification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ needs.pre-deploy-validation.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

    - name: Deployment Failure Notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment to ${{ needs.pre-deploy-validation.outputs.environment }} failed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Rollback Instructions" >> $GITHUB_STEP_SUMMARY
        echo "If needed, trigger a manual rollback using the [Rollback Workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/rollback.yml)" >> $GITHUB_STEP_SUMMARY

    - name: Create deployment comment on commit
      if: needs.deploy.result == 'success'
      uses: actions/github-script@v6
      with:
        script: |
          const environment = '${{ needs.pre-deploy-validation.outputs.environment }}';
          const emoji = environment === 'production' ? 'ðŸš€' : 'ðŸ”§';

          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `${emoji} **Deployment Successful**\n\n` +
                  `- **Environment:** ${environment}\n` +
                  `- **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n` +
                  `- **Timestamp:** ${new Date().toISOString()}`
          });
