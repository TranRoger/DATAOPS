name: Deploy DBT Pipeline

on:
  push:
    branches:
    - develop # Auto-deploy to development
    - main # Auto-deploy to production

  pull_request:
    branches: [ main, develop ]

env:
  DBT_PROFILES_DIR: ./dbt
  SA_PASSWORD: ${{ secrets.SA_PASSWORD }}
  DBT_PASSWORD: ${{ secrets.DBT_PASSWORD }}

jobs:
  # ============================================
  # Pre-deployment Validation
  # ============================================
  pre-deploy-validation:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      target: ${{ steps.set-env.outputs.target }}

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: ${{ secrets.SA_PASSWORD }}
          MSSQL_PID: Developer
        ports:
        - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P $SA_PASSWORD -C -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P $SA_PASSWORD -Q 'SELECT 1'" --health-interval 10s --health-timeout 5s --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Determine deployment environment
      id: set-env
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "target=prod" >> $GITHUB_OUTPUT
          echo "üöÄ Deploying to PRODUCTION environment"
        else
          echo "environment=development" >> $GITHUB_OUTPUT
          echo "target=dev" >> $GITHUB_OUTPUT
          echo "üîß Deploying to DEVELOPMENT environment"
        fi

    - name: Install SQL Server tools
      run: |
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
        echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> ~/.bashrc

    - name: Wait for SQL Server to be ready
      run: |
        echo "‚è≥ Waiting for SQL Server to be ready..."
        for i in {1..30}; do
          if /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -Q "SELECT 1" &>/dev/null; then
            echo "‚úÖ SQL Server is ready!"
            break
          fi
          echo "Waiting... attempt $i/30"
          sleep 5
        done

    - name: Download and restore AdventureWorks database
      run: |
        echo "üì• Downloading AdventureWorks2014 backup..."
        # Download the backup file
        curl -L -o /tmp/AdventureWorks2014.bak "https://github.com/Microsoft/sql-server-samples/releases/download/adventureworks/AdventureWorks2014.bak"

        echo "üîÑ Copying backup file into SQL Server container..."
        # Dynamically find the running SQL Server container ID
        CONTAINER_ID=$(docker ps --filter "ancestor=mcr.microsoft.com/mssql/server:2019-latest" --format "{{.ID}}")

        # Verify container was found before proceeding
        if [ -z "$CONTAINER_ID" ]; then
          echo "‚ùå Error: SQL Server container not found!"
          exit 1
        fi

        # Copy file into the container
        docker cp /tmp/AdventureWorks2014.bak $CONTAINER_ID:/tmp/AdventureWorks2014.bak

        echo "üì¶ Restoring AdventureWorks2014 database..."
        # Run the restore command using sqlcmd inside the runner (connecting to localhost)
        # Note: Added NO_WAIT and STATS for better logging
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -Q "
          RESTORE DATABASE AdventureWorks2014
          FROM DISK = '/tmp/AdventureWorks2014.bak'
          WITH
            MOVE 'AdventureWorks2014_Data' TO '/var/opt/mssql/data/AdventureWorks2014.mdf',
            MOVE 'AdventureWorks2014_Log' TO '/var/opt/mssql/data/AdventureWorks2014_log.ldf',
            REPLACE,
            STATS = 10;
        "

        echo "üë§ Creating database users..."
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -d AdventureWorks2014 -Q "
          CREATE LOGIN imrandbtnew WITH PASSWORD = '${{ env.DBT_PASSWORD }}';
          CREATE USER imrandbtnew FOR LOGIN imrandbtnew;
          ALTER ROLE db_owner ADD MEMBER imrandbtnew;
        "

        echo "‚úÖ AdventureWorks2014 database restored successfully"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install DBT
      run: |
        echo "üì¶ Installing DBT..."
        pip install dbt-sqlserver==1.8.5
        pip install dbt-fabric

    - name: Create profiles.yml from secret
      run: |
        cat <<EOF > dbt/profiles.yml
        ${{ secrets.DBT_PROFILE }}
        EOF

    - name: Install DBT dependencies
      run: |
        cd dbt
        echo "üì¶ Installing DBT packages..."
        dbt deps --profiles-dir .

    - name: Validate DBT project
      run: |
        cd dbt
        echo "üîç Validating DBT project structure..."
        dbt debug --profiles-dir .
        echo "‚úÖ DBT project validation passed"

    - name: Compile models (dry run)
      run: |
        cd dbt
        echo "üîÑ Compiling DBT models..."
        dbt compile --profiles-dir .
        echo "‚úÖ DBT models compiled successfully"

    - name: Pre-deployment Summary
      run: |
        echo "## üîç Pre-deployment Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ steps.set-env.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Target | ${{ steps.set-env.outputs.target }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| DBT Validation | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| DBT Compile | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy DBT Models
  # ============================================
  deploy:
    name: Deploy to ${{ needs.pre-deploy-validation.outputs.environment }}
    runs-on: ubuntu-latest
    needs: pre-deploy-validation
    environment:
      name: ${{ needs.pre-deploy-validation.outputs.environment }}

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: ${{ secrets.SA_PASSWORD }}
          MSSQL_PID: Developer
        ports:
        - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P $SA_PASSWORD -C -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P $SA_PASSWORD -Q 'SELECT 1'" --health-interval 10s --health-timeout 5s --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install SQL Server tools
      run: |
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev

    - name: Download and restore AdventureWorks database
      run: |
        echo "‚è≥ Waiting for SQL Server..."
        for i in {1..30}; do
          if /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -Q "SELECT 1" &>/dev/null; then
            echo "‚úÖ SQL Server is ready!"
            break
          fi
          sleep 5
        done

        echo "üì• Downloading AdventureWorks2014 backup..."
        curl -L -o /tmp/AdventureWorks2014.bak \
          "https://github.com/Microsoft/sql-server-samples/releases/download/adventureworks/AdventureWorks2014.bak"

        echo "üì¶ Copying backup file into SQL Server container..."
        CONTAINER_ID=$(docker ps --filter "ancestor=mcr.microsoft.com/mssql/server:2019-latest" --format "{{.ID}}")
        docker cp /tmp/AdventureWorks2014.bak $CONTAINER_ID:/tmp/AdventureWorks2014.bak

        echo "üîß Restoring AdventureWorks2014 database..."
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -Q "
          RESTORE DATABASE AdventureWorks2014
          FROM DISK = '/tmp/AdventureWorks2014.bak'
          WITH MOVE 'AdventureWorks2014_Data' TO '/var/opt/mssql/data/AdventureWorks2014.mdf',
               MOVE 'AdventureWorks2014_Log' TO '/var/opt/mssql/data/AdventureWorks2014_log.ldf',
               REPLACE;
        "

        echo "üë§ Creating DBT user and schemas..."
        /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -d AdventureWorks2014 -Q "
          CREATE LOGIN dbt_user WITH PASSWORD = '${{ env.DBT_PASSWORD }}';
          CREATE USER dbt_user FOR LOGIN dbt_user;
          ALTER ROLE db_owner ADD MEMBER dbt_user;

          CREATE LOGIN imrandbtnew WITH PASSWORD = '${{ env.DBT_PASSWORD }}';
          CREATE USER imrandbtnew FOR LOGIN imrandbtnew;
          ALTER ROLE db_owner ADD MEMBER imrandbtnew;

          CREATE SCHEMA bronze;
          CREATE SCHEMA silver;
          CREATE SCHEMA gold;
          CREATE SCHEMA dbo_dev;
        "
        echo "‚úÖ Database restore complete"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install DBT
      run: |
        echo "üì¶ Installing DBT..."
        # Upgrade both to ensure compatibility
        pip install dbt-sqlserver==1.8.5 dbt-fabric

    - name: Create profiles.yml from secret
      run: |
        cat <<EOF > dbt/profiles.yml
        ${{ secrets.DBT_PROFILE }}
        EOF

    - name: Install DBT dependencies
      id: dbt-deps
      run: |
        cd dbt
        echo "üì¶ Installing DBT packages..."
        dbt deps --profiles-dir .
        echo "‚úÖ DBT dependencies installed"

    - name: Run DBT models
      id: dbt-run
      run: |
        cd dbt
        echo "üîÑ Running DBT models for ${{ needs.pre-deploy-validation.outputs.environment }}..."
        dbt run --profiles-dir . --target ${{ needs.pre-deploy-validation.outputs.target }} 2>&1 | tee dbt_run.log
        echo "‚úÖ DBT models executed successfully"

    - name: Execute data quality tests
      id: dbt-test
      run: |
        cd dbt
        echo "üß™ Running data quality tests..."
        dbt test --profiles-dir . --target ${{ needs.pre-deploy-validation.outputs.target }} 2>&1 | tee dbt_test.log
        echo "‚úÖ Data quality tests passed"

    - name: Generate DBT documentation
      run: |
        cd dbt
        echo "üìö Generating DBT documentation..."
        dbt docs generate --profiles-dir . --target ${{ needs.pre-deploy-validation.outputs.target }}
        echo "‚úÖ Documentation generated"

    - name: Upload deployment logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: deployment-logs-${{ needs.pre-deploy-validation.outputs.environment }}-${{ github.run_number }}
        path: |
          dbt/dbt_run.log
          dbt/dbt_test.log
          dbt/target/run_results.json
          dbt/target/manifest.json
        retention-days: 30

    - name: Deployment Summary
      if: success()
      run: |
        echo "## üöÄ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | **${{ needs.pre-deploy-validation.outputs.environment }}** |" >> $GITHUB_STEP_SUMMARY
        echo "| Target | ${{ needs.pre-deploy-validation.outputs.target }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Run Number | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚úÖ Deployment Steps Completed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] DBT dependencies installed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] DBT models executed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Data quality tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Documentation generated" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Post-deployment Health Checks
  # ============================================
  post-deploy-health-check:
    name: Post-deployment Health Check
    runs-on: ubuntu-latest
    needs: [ pre-deploy-validation, deploy ]
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install DBT
      run: |
        pip install dbt-sqlserver==1.8.2

    - name: Create profiles.yml from secret
      run: |
        echo "${{ secrets.DBT_PROFILE }}" > dbt/profiles.yml

    - name: Install DBT dependencies
      run: |
        cd dbt
        dbt deps --profiles-dir .

    - name: Run health check tests
      run: |
        cd dbt
        echo "üè• Running post-deployment health checks..."
        # Run a subset of critical tests to verify deployment
        dbt test --profiles-dir . --target ${{ needs.pre-deploy-validation.outputs.target }} --select "tag:critical" 2>&1 || true
        echo "‚úÖ Health checks completed"

    - name: Verify model freshness
      run: |
        cd dbt
        echo "‚è∞ Checking source freshness..."
        dbt source freshness --profiles-dir . --target ${{ needs.pre-deploy-validation.outputs.target }} 2>&1 || true
        echo "‚úÖ Freshness check completed"

    - name: Health Check Summary
      run: |
        echo "## üè• Post-deployment Health Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Critical Tests | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Source Freshness | ‚úÖ Verified |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployment | ‚úÖ Healthy |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deployment Notification
  # ============================================
  notify:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: [ pre-deploy-validation, deploy, post-deploy-health-check ]
    if: always()

    steps:
    - name: Deployment Success Notification
      if: needs.deploy.result == 'success'
      run: |
        echo "## üéâ Deployment Notification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚úÖ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ needs.pre-deploy-validation.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

    - name: Deployment Failure Notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "## ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment to ${{ needs.pre-deploy-validation.outputs.environment }} failed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîÑ Rollback Instructions" >> $GITHUB_STEP_SUMMARY
        echo "If needed, trigger a manual rollback using the [Rollback Workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/rollback.yml)" >> $GITHUB_STEP_SUMMARY

    - name: Create deployment comment on commit
      if: needs.deploy.result == 'success'
      uses: actions/github-script@v6
      with:
        script: |
          const environment = '${{ needs.pre-deploy-validation.outputs.environment }}';
          const emoji = environment === 'production' ? 'üöÄ' : 'üîß';

          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `${emoji} **Deployment Successful**\n\n` +
                  `- **Environment:** ${environment}\n` +
                  `- **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n` +
                  `- **Timestamp:** ${new Date().toISOString()}`
          });
